<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baidu.lease.web.admin.mapper.ApartmentInfoMapper">

    <select id="pageApartmentItemByQuery" resultType="com.baidu.lease.web.admin.vo.apartment.ApartmentItemVo">
        select t4.*, (total_room_count - t4.cound_status) as free_room_count
        from apartment_info
                 left join (select t1.*, t2.total_room_count, t3.cound_status
                            from (select * from apartment_info where is_deleted = 0) as t1
                                     left join
                                 (select count(id) as total_room_count, apartment_id
                                  from room_info
                                  where is_deleted = 0
                                    and is_release = 1
                                  group by apartment_id) as t2
                                 on t1.id = t2.apartment_id
                                     left join
                                 (select count(status) as cound_status, apartment_id
                                  from lease_agreement
                                  where is_deleted = 0
                                    and status in (2, 5)
                                  group by apartment_id) as t3
                                 on t1.id = t3.apartment_id) as t4
                           on apartment_info.id = t4.id
        <where>
            <if test="queryVo.provinceId!=null">
                and t4.province_id = #{queryVo.provinceId}
            </if>
            <if test="queryVo.cityId!=null">
                and t4.city_id = #{queryVo.cityId}
            </if>
            <if test="queryVo.districtId!=null">
                and t4.district_id=#{queryVo.districtId}
            </if>
        </where>


<!--下面的语句是老师写的-->
        <!--select t4.*  , (t4.total_room_count-t4.room_count) as 'free_room_count'
        from
        (select t1.*, ifnull(t2.total_room_count, 0) as 'total_room_count', ifnull(t3.count_room, 0) as 'room_count'
        from (select * from apartment_info where is_deleted = 0) t1
        left join
        (select apartment_id, count(id) as total_room_count
        from room_info
        where is_deleted = 0
        and is_release = 1
        group by apartment_id) t2
        on t1.id = t2.apartment_id
        left join
        (select apartment_id, count(id) as count_room
        from lease_agreement
        where is_deleted = 0
        and status in (2, 5)
        group by apartment_id) t3
        on t1.id = t3.apartment_id
        ) t4
        <where>
            <if test="queryVo.provinceId!=null">
                and t4.province_id = #{queryVo.provinceId}
            </if>
            <if test="queryVo.cityId!=null">
                and t4.city_id = #{queryVo.cityId}
            </if>
            <if test="queryVo.districtId!=null">
                and t4.district_id=#{queryVo.districtId}
            </if>
        </where>-->



</select>

</mapper>
